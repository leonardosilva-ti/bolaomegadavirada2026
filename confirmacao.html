<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Confirmação da Aposta</title>
<link rel="stylesheet" href="css/style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<main class="container">
  <h1>Confirmação da Aposta</h1>
  <div id="info"></div>
  <div id="jogos"></div>
  <label class="termo">
    <input type="checkbox" id="aceito2"> Li e aceito os termos
  </label>
  <div class="controles">
    <button id="btnBaixar" class="primary">Confirmar e Enviar</button>
    <button id="btnVoltar" class="muted">Voltar</button>
  </div>
</main>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbylsOPklfzElA8ZYF7wYneORp5nWymkrnDzXhVK-onsnb9PXze16S50yVbu059g_w4tLA/exec";

const pending = JSON.parse(localStorage.getItem("pendingAposta") || "null");
if (!pending) {
  document.body.innerHTML = "<p>Nenhuma aposta pendente. Volte à página inicial.</p>";
}

document.getElementById("info").innerHTML = `<p><strong>Nome:</strong> ${pending.nome}<br><strong>Telefone:</strong> ${pending.telefone}</p>`;
document.getElementById("jogos").innerHTML = pending.jogos.map((j,i)=>`<p><b>Jogo ${i+1}:</b> ${j}</p>`).join("");

document.getElementById("btnBaixar").onclick = async () => {
  if (!document.getElementById("aceito2").checked) return alert("Você precisa aceitar os termos.");
  const resp = await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(pending) });
  const json = await resp.json();
  if (json.status === "OK" && json.receipt) {
    gerarPDF(pending, json.receipt, "Aguardando Pagamento");
    localStorage.removeItem("pendingAposta");
    alert("Aposta enviada!");
  } else {
    alert("Erro ao enviar aposta.");
  }
};

function gerarPDF(payload, receipt, status) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const data = new Date().toLocaleString("pt-BR");
  let y = 15;
  doc.setFontSize(16);
  doc.text("Comprovante - Bolão Mega da Virada", 12, y);
  y += 10;
  doc.setFontSize(11);
  doc.text(`Receipt: ${receipt}`, 12, y); y += 8;
  doc.text(`Nome: ${payload.nome}`, 12, y); y += 8;
  doc.text(`Telefone: ${payload.telefone}`, 12, y); y += 8;
  doc.text(`Status: ${status}`, 12, y); y += 8;
  doc.text(`Data/Hora: ${data}`, 12, y); y += 10;
  doc.text("Jogos:", 12, y); y += 6;
  payload.jogos.forEach((j,i)=>{ doc.text(`${i+1}: ${j}`, 12, y); y+=7; if (y>270){doc.addPage(); y=12;} });
  doc.save(`comprovante_${receipt}.pdf`);
}
</script>
</body>
</html>
