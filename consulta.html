<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Consulta de Jogos</title>
<link rel="stylesheet" href="css/style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<main class="container">
  <h1>Consultar Jogos</h1>
  <div class="form-row">
    <input type="text" id="nome" placeholder="Nome completo">
    <input type="text" id="ultimos4" placeholder="Últimos 4 números do telefone">
    <button id="buscar" class="primary">Buscar</button>
  </div>
  <div id="resultado"></div>
</main>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbylsOPklfzElA8ZYF7wYneORp5nWymkrnDzXhVK-onsnb9PXze16S50yVbu059g_w4tLA/exec";

document.getElementById("buscar").onclick = async () => {
  const nomeInput = document.getElementById("nome").value.trim();
  const ult4 = document.getElementById("ultimos4").value.trim();
  if (!nomeInput || !ult4) return alert("Informe o primeiro nome e os 4 últimos números do telefone.");

  const primeiroNome = nomeInput.split(/\s+/)[0].toLowerCase();

  try {
    const res = await fetch(SCRIPT_URL + "?action=get");
    const data = await res.json();

    const matches = data.filter(r => {
      const rNome = String(r.nome || "").trim().split(/\s+/)[0].toLowerCase();
      const rTelLast4 = String(r.telefone || "").slice(-4);
      return rNome === primeiroNome && rTelLast4 === String(ult4);
    });

    const div = document.getElementById("resultado");
    div.innerHTML = "";
    if (matches.length === 0) {
      div.innerHTML = "<p>Nenhuma aposta encontrada.</p>";
      return;
    }

    matches.forEach(m => {
      const status = (String(m.pago || m.Pago || "").toLowerCase() === "sim" || String(m.pago || m.Pago || "").toLowerCase() === "true") ? "Pago" : "Aguardando Pagamento";
      const jogos = (m.jogos || m["Jogo 1"] || []).length ? (m.jogos || [m["Jogo 1"], m["Jogo 2"], m["Jogo 3"], m["Jogo 4"], m["Jogo 5"]]) : [];
      const jogosHTML = (Array.isArray(jogos) ? jogos : []).filter(Boolean).map((j,i)=>`<p><b>Jogo ${i+1}:</b> ${j}</p>`).join("");
      const receipt = m.receipt || m.ReceiptID || "";
      div.innerHTML += `
        <div class="card">
          <p><b>Nome:</b> ${m.nome || m.Nome} <br><b>Telefone:</b> ${m.telefone || m.Telefone} <br><b>Status:</b> ${status}</p>
          ${jogosHTML}
          <button class="muted" onclick='gerarPDFConsulta(${JSON.stringify(m)})'>Baixar Comprovante</button>
        </div>
      `;
    });

  } catch (err) {
    alert("Erro ao consultar: " + err.message);
  }
};


function gerarPDF(m) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const status = (String(m.pago || m.Pago || "").toLowerCase() === "sim" || String(m.pago || m.Pago || "").toLowerCase() === "true") ? "Pago" : "Aguardando Pagamento";
  const timestamp = m.Timestamp || m.timestamp || m.Timestamp || new Date().toISOString();
  const data = new Date(timestamp).toLocaleString("pt-BR");
  let y = 15;
  doc.setFontSize(16); doc.text("Comprovante - Bolão Mega da Virada", 12, y); y+=10;
  doc.setFontSize(11); doc.text(`Receipt: ${m.receipt || m.ReceiptID || ""}`, 12, y); y+=8;
  doc.text(`Nome: ${m.nome || m.Nome}`, 12, y); y+=8;
  doc.text(`Telefone: ${m.telefone || m.Telefone}`, 12, y); y+=8;
  doc.text(`Status: ${status}`, 12, y); y+=8;
  doc.text(`Data/Hora: ${data}`, 12, y); y+=10;
  doc.text("Jogos:", 12, y); y+=6;
  const jogos = m.jogos || [m["Jogo 1"], m["Jogo 2"], m["Jogo 3"], m["Jogo 4"], m["Jogo 5"]];
  (Array.isArray(jogos) ? jogos : []).filter(Boolean).forEach((j,i)=>{ doc.text(`${i+1}: ${j}`, 12, y); y+=7; if (y>270){ doc.addPage(); y=12;} });
  doc.save(`comprovante_${m.receipt || m.ReceiptID || "unknown"}.pdf`);
}


</script>
</body>
</html>
